# PikPak Batch Renamer Build Script

.PHONY: build test clean dev help

# Default target
all: build

# Build userscript
build:
	@echo "üî® Building userscript..."
	@echo "üìã Current version: $$(cat VERSION)"
	@node build.js
	@echo "‚úÖ Build completed! Version: $$(cat VERSION)"

# Run tests
test:
	@echo "üß™ Starting test environment..."
	@echo "Starting CORS proxy server..."
	@node proxy-server.js &
	@sleep 2
	@echo "Starting test server..."
	@echo "Please visit in browser: http://localhost:8080/test/test.html"
	@python3 -m http.server 8080

# Clean build files
clean:
	@echo "üßπ Cleaning build files..."
	@rm -rf dist/*
	@echo "‚úÖ Cleanup completed"

# Development mode: watch files and auto-build
dev:
	@echo "üëÄ Development mode: watching file changes..."
	@echo "Auto-build will trigger when src/core-functions.js is modified"
	@while true; do \
		inotifywait -e modify src/core-functions.js 2>/dev/null || \
		fswatch -1 src/core-functions.js 2>/dev/null || \
		(echo "‚ö†Ô∏è  File watching not available, please run make build manually"; break); \
		make build; \
	done

# Show help information
help:
	@echo "PikPak Batch Renamer - Build Tool"
	@echo ""
	@echo "Available commands:"
	@echo "  make build   - Build userscript"
	@echo "  make test    - Start test server"
	@echo "  make clean   - Clean build files"
	@echo "  make dev     - Development mode (auto-build)"
	@echo "  make help    - Show this help message"
	@echo ""
	@echo "Workflow:"
	@echo "  1. Edit src/core-functions.js"
	@echo "  2. Run make test for testing"
	@echo "  3. Run make build to generate userscript"
	@echo "  4. Install dist/pikpak-batch-renamer.user.js"