<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PikPak ç•ªå·æå–æµ‹è¯•</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace; 
            margin: 20px; 
            background: #f8f9fa;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .test { 
            margin: 15px 0; 
            padding: 15px; 
            border-left: 4px solid #ccc; 
            border-radius: 0 6px 6px 0;
            background: #f8f9fa;
        }
        .pass { 
            border-color: #28a745; 
            background: #d4edda; 
        }
        .fail { 
            border-color: #dc3545; 
            background: #f8d7da; 
        }
        .test h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        .section { 
            margin: 8px 0; 
            padding: 8px;
            background: rgba(255,255,255,0.7);
            border-radius: 4px;
        }
        .section strong {
            display: inline-block;
            width: 80px;
            font-weight: 600;
        }
        .expected { 
            color: #666; 
            font-size: 13px;
            margin: 2px 0;
        }
        .actual { 
            color: #000; 
            font-size: 13px;
            margin: 2px 0;
        }
        .error { 
            color: #dc3545; 
        }
        .status-icon {
            font-size: 14px;
            margin-right: 5px;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PikPak ç•ªå·æå–æµ‹è¯•</h1>
        <div id="summary" class="summary">
            <span class="loading">æ­£åœ¨åŠ è½½æµ‹è¯•ç”¨ä¾‹...</span>
        </div>
        <div id="results"></div>
    </div>

    <script type="module">
        import { extractKeyword, predictDirectAccess, getSearchFallback, queryAVwiki, queryDMM, getFallbackDetailUrl } from '../src/core-functions.js';

        // ä¸ºæµ‹è¯•ç¯å¢ƒæä¾› httpRequest å‡½æ•°ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨
        window.httpRequest = function(options) {
            return new Promise((resolve, reject) => {
                const proxyUrl = `http://localhost:3001?url=${encodeURIComponent(options.url)}`;
                
                fetch(proxyUrl, {
                    method: options.method || 'GET',
                    headers: options.headers || {}
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.text();
                })
                .then(responseText => {
                    resolve({
                        status: 200,
                        responseText: responseText
                    });
                })
                .catch(error => {
                    reject(error);
                });
            });
        };

        // è®¾ç½®æµ‹è¯•ç”¨çš„DMMé…ç½® (ä½¿ç”¨æµ‹è¯•ç”¨çš„å‡æ•°æ®)
        window.PikPakRenamerConfig = {
            dmm: {
                enabled: false, // é»˜è®¤å…³é—­ï¼Œé¿å…è¯¯ç”¨
                apiId: 'TEST_API_ID', // æµ‹è¯•ç”¨å‡æ•°æ®
                affiliateId: 'TEST_AFFILIATE_ID' // æµ‹è¯•ç”¨å‡æ•°æ®
            }
        };

        async function runTests() {
            try {
                const response = await fetch('./test-cases.json');
                const testCases = await response.json();
                const results = document.getElementById('results');
                const summary = document.getElementById('summary');
                
                let passCount = 0;
                let failCount = 0;

                // ä½¿ç”¨ Promise.all å¤„ç†å¼‚æ­¥æµ‹è¯•
                const testPromises = testCases.map(async (testCase, index) => {
                    const div = document.createElement('div');
                    
                    // ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹ä¸­çš„ isFile å­—æ®µï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç  false
                    const isFile = testCase.isFile || false;
                    const extractResult = extractKeyword(testCase.fileName, isFile);
                    const directResult = extractResult ? predictDirectAccess(extractResult.keyword) : predictDirectAccess('');
                    const fallbackResult = extractResult ? getSearchFallback(extractResult.originalMatch) : getSearchFallback('');
                    
                    // è¿è¡Œå¼‚æ­¥ AV-wiki æµ‹è¯•
                    let avwikiResult = null;
                    let avwikiPass = true;
                    let fallbackDetailUrl = null;
                    
                    // è¿è¡Œå¼‚æ­¥ DMM æµ‹è¯•
                    let dmmResult = null;
                    let dmmPass = true;
                    
                    if (extractResult && extractResult.keyword) {
                        try {
                            fallbackDetailUrl = await getFallbackDetailUrl(extractResult.originalMatch);
                            avwikiResult = await queryAVwiki(extractResult);
                            avwikiPass = compareResults(avwikiResult, testCase.avwikiResult);
                        } catch (error) {
                            avwikiResult = null;
                            avwikiPass = testCase.avwikiResult === null;
                        }
                        
                        try {
                            dmmResult = await queryDMM(extractResult);
                            dmmPass = compareResults(dmmResult, testCase.dmmResult);
                        } catch (error) {
                            dmmResult = null;
                            dmmPass = testCase.dmmResult === null;
                        }
                    } else {
                        avwikiPass = testCase.avwikiResult === null;
                        dmmPass = testCase.dmmResult === null;
                    }
                    
                    // æ£€æŸ¥ç»“æœ
                    const extractPass = compareResults(extractResult, testCase.extractResult);
                    const directPass = compareResults(directResult, testCase.directAccess);
                    const fallbackPass = compareResults(fallbackResult, testCase.searchFallback);
                    const fallbackDetailPass = compareResults(fallbackDetailUrl, testCase.fallbackDetailUrl);
                    
                    const allPass = extractPass && directPass && fallbackPass && fallbackDetailPass && avwikiPass && dmmPass;
                    
                    div.className = `test ${allPass ? 'pass' : 'fail'}`;
                    div.innerHTML = `
                        <h3>${allPass ? 'âœ…' : 'âŒ'} æµ‹è¯• ${index + 1}: ${testCase.fileName}</h3>
                        <div style="margin-bottom: 10px; color: #666; font-size: 0.9em;">
                            ç±»å‹: ${isFile ? 'ğŸ“„ æ–‡ä»¶' : 'ğŸ“ æ–‡ä»¶å¤¹'}
                        </div>
                        
                        <div class="section">
                            <strong>æå–æ ¼å¼:</strong> 
                            <span class="status-icon">${extractPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.extractResult)}</div>
                            <div class="actual">å®é™…: ${formatResult(extractResult)}</div>
                        </div>
                        
                        <div class="section">
                            <strong>ç›´æ¥è®¿é—®:</strong> 
                            <span class="status-icon">${directPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.directAccess)}</div>
                            <div class="actual">å®é™…: ${formatResult(directResult)}</div>
                        </div>
                        
                        <div class="section">
                            <strong>å›é€€æœç´¢:</strong> 
                            <span class="status-icon">${fallbackPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.searchFallback)}</div>
                            <div class="actual">å®é™…: ${formatResult(fallbackResult)}</div>
                        </div>
                        
                        <div class="section">
                            <strong>å›é€€æœç´¢è¯¦æƒ…é¡µ:</strong> 
                            <span class="status-icon">${fallbackDetailPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.fallbackDetailUrl)}</div>
                            <div class="actual">å®é™…: ${formatResult(fallbackDetailUrl)}</div>
                        </div>
                        
                        <div class="section">
                            <strong>AV-wikiæŸ¥è¯¢:</strong> 
                            <span class="status-icon">${avwikiPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.avwikiResult)}</div>
                            <div class="actual">å®é™…: ${formatResult(avwikiResult)}</div>
                        </div>
                        
                        <div class="section">
                            <strong>DMMæŸ¥è¯¢:</strong> 
                            <span class="status-icon">${dmmPass ? 'âœ…' : 'âŒ'}</span>
                            <div class="expected">æœŸæœ›: ${formatResult(testCase.dmmResult)}</div>
                            <div class="actual">å®é™…: ${formatResult(dmmResult)}</div>
                        </div>
                    `;
                    
                    return { div, allPass };
                });

                // ç­‰å¾…æ‰€æœ‰æµ‹è¯•å®Œæˆ
                const testResults = await Promise.all(testPromises);
                
                // æ·»åŠ ç»“æœåˆ°é¡µé¢å¹¶ç»Ÿè®¡
                testResults.forEach(({ div, allPass }) => {
                    if (allPass) passCount++;
                    else failCount++;
                    results.appendChild(div);
                });

                // æ›´æ–°æ‘˜è¦
                const total = passCount + failCount;
                const passRate = ((passCount / total) * 100).toFixed(1);
                summary.innerHTML = `
                    <div>
                        <strong>æµ‹è¯•ç»“æœ:</strong> 
                        æ€»è®¡ ${total} ä¸ªï¼Œé€šè¿‡ ${passCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª
                    </div>
                    <div style="color: ${passCount === total ? '#28a745' : '#dc3545'}">
                        é€šè¿‡ç‡: ${passRate}%
                    </div>
                `;

            } catch (error) {
                document.getElementById('results').innerHTML = `
                    <div class="test fail">
                        <h3>âŒ åŠ è½½æµ‹è¯•å¤±è´¥</h3>
                        <div class="error">é”™è¯¯: ${error.message}</div>
                        <div style="margin-top: 10px; font-size: 13px;">
                            è¯·æ£€æŸ¥ï¼š<br>
                            1. æ˜¯å¦ä½¿ç”¨ HTTP æœåŠ¡å™¨è¿è¡Œï¼ˆå¦‚ Live Serverï¼‰<br>
                            2. core.js å’Œ test-cases.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>
                            3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                        </div>
                    </div>
                `;
                document.getElementById('summary').innerHTML = `
                    <span style="color: #dc3545">åŠ è½½å¤±è´¥</span>
                `;
            }
        }

        function compareResults(actual, expected) {
            if (actual === null && expected === null) return true;
            if (actual === null || expected === null) return false;
            
            // å¦‚æœexpectedæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ¯”è¾ƒ
            if (typeof expected === 'string') {
                return actual === expected;
            }
            
            // å¦‚æœexpectedæ˜¯å¯¹è±¡ï¼Œåªæ¯”è¾ƒæœŸæœ›ç»“æœä¸­å­˜åœ¨çš„å­—æ®µ
            if (typeof expected === 'object' && expected !== null) {
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœexpected.format === nullï¼Œè¯´æ˜æ•´ä¸ªç»“æœåº”è¯¥æ˜¯null
                if (expected.format === null) {
                    return actual === null;
                }
                
                for (const [key, expectedValue] of Object.entries(expected)) {
                    if (actual[key] !== expectedValue) {
                        return false;
                    }
                }
                return true;
            }
            
            return actual === expected;
        }

        function formatResult(result) {
            if (result === null) return 'null';
            if (typeof result === 'object') {
                return Object.entries(result)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(' | ');
            }
            return String(result);
        }

        runTests();
    </script>
</body>
</html>